#!/usr/bin/env python3
import subprocess
import sys

def get_git_diff(path="."):
    try:
        diff = subprocess.check_output(['git', '-C', path, 'diff', '--cached']).decode('utf-8')
        if not diff.strip():
            print("No changes detected (git diff is empty). Please stage or modify files.")
            sys.exit(1)
        return diff
    except subprocess.CalledProcessError:
        print("Error: Make sure this path is a git repository with changes.")
        sys.exit(1)

def query_ollama(prompt, model="llama2"):
    try:
        result = subprocess.check_output(['ollama', 'run', model, prompt], text=True)
        return result.strip()
    except subprocess.CalledProcessError as e:
        print("Error calling Ollama:", e)
        sys.exit(1)

def generate_pr_text(diff_text):
    prompt = f"Summarize the following git diff into a concise Pull Request title and detailed description:\n\n{diff_text}\n\nPR title:\nPR description:"
    return query_ollama(prompt)

def main():
    path = "."
    diff = get_git_diff(path)
    print("\nGenerating PR title and description using Ollama AI...\n")
    pr_text = generate_pr_text(diff)
    print("\n=== Generated Pull Request ===\n")
    print(pr_text)

if __name__ == '__main__':
    main()